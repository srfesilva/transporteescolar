# Salve este c√≥digo como app.py no seu computador
import streamlit as st
import sqlite3
import pandas as pd

# Configura√ß√£o da P√°gina
st.set_page_config(page_title="Gest√£o Transporte Escolar")

# Conex√£o Banco (Em mem√≥ria para teste ou persistente se hospedado)
conn = sqlite3.connect('transporte.db', check_same_thread=False)
c = conn.cursor()

# Criar Tabelas
c.execute('''CREATE TABLE IF NOT EXISTS alunos 
             (nome TEXT, cpf TEXT, status TEXT, arq_medico BLOB, arq_viagem BLOB)''')
conn.commit()

# --- ABA ESCOLA ---
st.sidebar.title("Navega√ß√£o")
escolha = st.sidebar.radio("Ir para:", ["Escola (Cadastro)", "Supervisor (Valida√ß√£o)"])

if escolha == "Escola (Cadastro)":
    st.title("üè´ Cadastro de Aluno")
    nome = st.text_input("Nome do Aluno")
    cpf = st.text_input("CPF")
    
    f_medico = st.file_uploader("Ficha M√©dica", type=['pdf', 'png', 'jpg'])
    f_viagem = st.file_uploader("Ficha Viagem", type=['pdf', 'png', 'jpg'])
    
    if st.button("Enviar Solicita√ß√£o"):
        if nome and cpf:
            # L√≥gica simplificada de salvamento
            c.execute("INSERT INTO alunos VALUES (?, ?, 'Pendente', ?, ?)", 
                      (nome, cpf, f_medico.read() if f_medico else None, f_viagem.read() if f_viagem else None))
            conn.commit()
            st.success(f"Aluno {nome} enviado para valida√ß√£o!")
        else:
            st.error("Preencha todos os campos.")

# --- ABA SUPERVISOR ---
elif escolha == "Supervisor (Valida√ß√£o)":
    st.title("üìã Valida√ß√£o Supervisor")
    
    # Listar Pendentes
    df = pd.read_sql("SELECT rowid, nome, cpf, status FROM alunos WHERE status='Pendente'", conn)
    
    if not df.empty:
        aluno_sel = st.selectbox("Selecione o Aluno:", df['nome'])
        id_aluno = df[df['nome'] == aluno_sel].index[0] # Simplifica√ß√£o
        
        st.write(f"Validando: **{aluno_sel}**")
        
        # Aqui voc√™ colocaria os bot√µes de download (st.download_button)
        
        f_assinado = st.file_uploader("Anexar Ficha Assinada")
        
        if st.button("Aprovar Transporte") and f_assinado:
            c.execute("UPDATE alunos SET status='Aprovado' WHERE nome=?", (aluno_sel,))
            conn.commit()
            st.success("Validado com sucesso!")
            st.rerun()
    else:
        st.info("Nenhuma pend√™ncia no momento.")
